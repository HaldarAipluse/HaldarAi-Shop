<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HaldarAi Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="https://developers.google.com/static/focus/images/ai-studio-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg-color: #0a0a1a; --primary-glow: #00ffff; --secondary-glow: #9400d3;
            --accent-glow: #39ff14; --error-glow: #ff3b30; --text-color: #f0f0f0;
            --glass-bg: rgba(10, 10, 30, 0.5); --glass-border: rgba(255, 255, 255, 0.2);
            --header-bg: rgba(10, 10, 30, 0.7); --sphere-1-color: #9400d3; --sphere-2-color: #ff6347;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow: hidden; position: relative; }
        body::before, body::after { content: ''; position: fixed; border-radius: 50%; filter: blur(120px); z-index: -1; }
        body::before { background: var(--sphere-1-color); width: 350px; height: 350px; top: 10vh; left: 10vw; animation: move-sphere1 18s infinite alternate ease-in-out; }
        body::after { background: var(--sphere-2-color); width: 300px; height: 300px; bottom: 5vh; right: 15vw; animation: move-sphere2 22s infinite alternate ease-in-out; }
        @keyframes move-sphere1 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(100px, 80px) rotate(180deg); } }
        @keyframes move-sphere2 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(-80px, -60px) rotate(-180deg); } }
        .container { padding: 70px 1rem 80px 1rem; height: 100vh; overflow-y: auto;}
        .hidden { display: none !important; }
        #admin-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; background: var(--header-bg); border-bottom: 1px solid var(--glass-border); position: fixed; top: 0; width:100%; z-index: 100; backdrop-filter: blur(10px); }
        #brand-info { display: flex; align-items: center; gap: 15px; }
        #brand-logo { max-height: 40px; border-radius: 50%; }
        #brand-name-header { font-size: 1.2rem; font-weight: 600; }
        .view { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-title { font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--primary-glow); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .glow-input, textarea.glow-input, select.glow-input { width: 100%; padding: 12px 15px; margin-bottom: 1rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-color); font-size: 1rem; }
        select.glow-input { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 15px center; background-size: .65em auto; }
        .glow-input:focus, textarea.glow-input:focus, select.glow-input:focus { outline: none; border-color: var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow); }
        .glow-btn { display: inline-block; padding: 12px 25px; border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 1rem; cursor: pointer; text-align: center; background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow)); box-shadow: 0 0 10px rgba(0, 255, 255, 0.5); transition: all 0.3s ease; }
        .glow-btn:hover { transform: scale(1.05); }
        .glow-btn.secondary { background: #555; box-shadow: none; }
        .glow-btn.danger { background: linear-gradient(45deg, var(--error-glow), #ff9500); }
        .full-width { width: 100%; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid var(--glass-border); padding: 2rem; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); }
        .item-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .item-grid { grid-template-columns: 1fr 1fr; } }
        .item-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 1rem; display: flex; flex-direction: column; }
        .item-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; margin-bottom: 1rem; }
        .item-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; word-break: break-word; }
        .item-card p { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; flex-grow: 1; }
        .item-card .price { font-weight: bold; color: var(--accent-glow); }
        .item-card-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 5px; font-size: 1.1rem; }
        .edit-btn:hover { color: var(--primary-glow); }
        .delete-btn:hover { color: var(--error-glow); }
        .list-view { display: flex; flex-direction: column; gap: 1rem; }
        .list-item-card { background: rgba(0, 255, 255, 0.05); border: 1px solid var(--primary-glow); padding: 1rem; border-radius: 16px; transition: background 0.3s ease; }
        .list-item-main { cursor: pointer; flex-grow: 1; }
        .list-item-card p { margin: 0; font-size: 0.9rem; line-height: 1.5; }
        .list-item-card strong { color: var(--primary-glow); }
        .list-item-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .list-item-header { display: flex; justify-content: space-between; align-items: flex-start; }
        #fab-add-btn { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent-glow); box-shadow: 0 4px 20px #39ff1488; border: none; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 500; transition: transform 0.3s ease; font-size: 1.5rem; }
        #fab-add-btn:hover { transform: scale(1.1); }
        #bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--header-bg); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; z-index: 100; backdrop-filter: blur(10px); }
        .nav-btn { background: none; border: none; color: var(--text-color); cursor: pointer; padding: 10px 12px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; opacity: 0.7; transition: all 0.3s ease; }
        .nav-btn i { font-size: 1.2rem; }
        .nav-btn.active { opacity: 1; color: var(--primary-glow); transform: translateY(-3px); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        #login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-card { width: 90%; max-width: 400px; text-align: center; }
        #login-card h1 { margin-bottom: 1.5rem; color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow); }
        .sub-section-title { font-size: 1.3rem; color: var(--secondary-glow); margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem; }
        .membership-badge { background-color: var(--accent-glow); color: black; font-size: 0.8rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-card" class="glass-card">
            <h1>Admin Login</h1>
            <form id="login-form"><input type="email" id="email" class="glow-input" placeholder="Email" required><input type="password" id="password" class="glow-input" placeholder="Password" required><button type="submit" class="glow-btn full-width">Login</button></form>
            <p id="login-error" style="color: var(--error-glow); margin-top: 1rem;"></p>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <header id="admin-header">
            <div id="brand-info"><img id="brand-logo" src="https://developers.google.com/static/focus/images/ai-studio-icon.png" alt="Logo"><span id="brand-name-header">HaldarAi Admin</span></div>
            <button id="logout-btn" class="glow-btn danger" style="padding: 8px 15px; font-size: 0.9rem;">Logout</button>
        </header>
        
        <main class="container">
            <div id="products-view" class="view"><h2 class="view-title">Products</h2><div id="product-grid" class="item-grid"></div></div>
            <div id="memberships-view" class="view hidden"><h2 class="view-title">Memberships</h2><div id="membership-grid" class="item-grid"></div></div>
            <div id="banners-view" class="view hidden"><h2 class="view-title">Banners</h2><div id="banner-grid" class="item-grid"></div></div>
            <div id="users-view" class="view hidden"><h2 class="view-title">Users</h2><div id="user-list" class="list-view"></div></div>
            <div id="orders-view" class="view hidden"><h2 class="view-title">Recent Orders</h2><div id="orders-list" class="list-view"></div></div>
            <div id="settings-view" class="view hidden">
                <h2 class="view-title">Shop Settings</h2>
                <div id="policies-container">
                    <form class="policy-form" data-key="refund"><label for="policy-refund">Refund Policy</label><textarea id="policy-refund" class="glow-input" rows="4"></textarea><button type="submit" class="glow-btn">Save Refund Policy</button></form>
                    <hr style="border-color: var(--glass-border); margin: 2rem 0;">
                    <form class="policy-form" data-key="terms"><label for="policy-terms">Terms & Conditions</label><textarea id="policy-terms" class="glow-input" rows="4"></textarea><button type="submit" class="glow-btn">Save T&C</button></form>
                    <hr style="border-color: var(--glass-border); margin: 2rem 0;">
                    <form class="policy-form" data-key="delivery"><label for="policy-delivery">Delivery Policy</label><textarea id="policy-delivery" class="glow-input" rows="4"></textarea><button type="submit" class="glow-btn">Save Delivery Policy</button></form>
                    <hr style="border-color: var(--glass-border); margin: 2rem 0;">
                    <form class="policy-form" data-key="privacy"><label for="policy-privacy">Privacy Policy</label><textarea id="policy-privacy" class="glow-input" rows="4"></textarea><button type="submit" class="glow-btn">Save Privacy Policy</button></form>
                </div>
            </div>
        </main>

        <button id="fab-add-btn" class="hidden"><i class="fa-solid fa-plus"></i></button>

        <nav id="bottom-nav">
            <button class="nav-btn active" data-view="products-view"><i class="fa-solid fa-box-archive"></i><span>Products</span></button>
            <button class="nav-btn" data-view="memberships-view"><i class="fa-solid fa-crown"></i><span>Memberships</span></button>
            <button class="nav-btn" data-view="banners-view"><i class="fa-solid fa-images"></i><span>Banners</span></button>
            <button class="nav-btn" data-view="users-view"><i class="fa-solid fa-users"></i><span>Users</span></button>
            <button class="nav-btn" data-view="orders-view"><i class="fa-solid fa-receipt"></i><span>Orders</span></button>
            <button class="nav-btn" data-view="settings-view"><i class="fa-solid fa-cog"></i><span>Settings</span></button>
        </nav>
    </div>
    
    <!-- MODALS -->
    <div id="product-modal" class="modal"><div class="modal-content glass-card">
        <h2 id="modal-title">Add Product</h2>
        <form id="product-form">
            <input type="hidden" id="productId"><input type="text" id="productTitle" class="glow-input" placeholder="Product Title" required>
            <input type="url" id="productImageUrl" class="glow-input" placeholder="Image URL" required><textarea id="productDescription" class="glow-input" placeholder="Description" rows="3" required></textarea>
            <div class="form-grid"><input type="number" id="originalPrice" class="glow-input" placeholder="Original Price" required><input type="number" id="discountPrice" class="glow-input" placeholder="Discount Price" required></div>
            <input type="url" id="paymentLink" class="glow-input" placeholder="Payment Link" required>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;"><button type="submit" class="glow-btn">Save</button><button type="button" class="glow-btn secondary modal-cancel-btn">Cancel</button></div>
        </form>
    </div></div>
    <div id="banner-modal" class="modal"><div class="modal-content glass-card">
        <h2 id="banner-modal-title">Add Banner</h2>
        <form id="banner-form">
            <input type="hidden" id="bannerId">
            <input type="url" id="bannerImageUrl" class="glow-input" placeholder="Banner Image URL" required><input type="url" id="bannerLinkUrl" class="glow-input" placeholder="Link URL (Optional)">
            <div style="display: flex; gap: 1rem; margin-top: 1rem;"><button type="submit" class="glow-btn">Save</button><button type="button" class="glow-btn secondary modal-cancel-btn">Cancel</button></div>
        </form>
    </div></div>
    <div id="membership-modal" class="modal"><div class="modal-content glass-card">
        <h2 id="membership-modal-title">Add Membership</h2>
        <form id="membership-form">
            <input type="hidden" id="membershipId">
            <input type="text" id="planName" class="glow-input" placeholder="Plan Name (e.g., Silver)" required>
            <input type="text" id="tagline" class="glow-input" placeholder="Tagline (e.g., SAVE 20%)">
            <div class="form-grid">
                <input type="number" id="price" class="glow-input" placeholder="Price" required>
                <input type="text" id="billingCycle" class="glow-input" placeholder="PER MONTH" required>
            </div>
            <input type="number" id="yearlyPrice" class="glow-input" placeholder="Yearly Price (e.g., 192)">
            <textarea id="description" class="glow-input" placeholder="Description" rows="2" required></textarea>
            <textarea id="features" class="glow-input" placeholder="Features (one per line)" rows="3"></textarea>
            <input type="url" id="membershipPaymentLink" class="glow-input" placeholder="Payment Link" required>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;"><button type="submit" class="glow-btn">Save Plan</button><button type="button" class="glow-btn secondary modal-cancel-btn">Cancel</button></div>
        </form>
    </div></div>
    <div id="user-detail-modal" class="modal"><div class="modal-content glass-card">
        <h2 id="user-detail-title">User Details</h2>
        <div id="user-detail-content"></div>
        <h3 class="sub-section-title">Purchase History</h3><div id="user-purchases-list" class="list-view"></div>
        <h3 class="sub-section-title">Bookmarked Items</h3><div id="user-bookmarks-list" class="list-view"></div>
        <button type="button" class="glow-btn secondary modal-cancel-btn" style="width: 100%; margin-top: 2rem;">Close</button>
    </div></div>
    <div id="user-edit-modal" class="modal"><div class="modal-content glass-card">
        <h2>Edit User Profile</h2>
        <form id="user-edit-form">
            <input type="hidden" id="userId">
            <label for="userEmail">Email</label><input type="email" id="userEmail" class="glow-input" readonly>
            <label for="userName">Name</label><input type="text" id="userName" class="glow-input">
            <label for="userPhone">Phone</label><input type="tel" id="userPhone" class="glow-input">
            <label for="userAddress">Address</label><textarea id="userAddress" class="glow-input" rows="3"></textarea>
            <label for="userImageUrl">Image URL</label><input type="url" id="userImageUrl" class="glow-input">
            <label for="userMembership">Active Membership</label><select id="userMembership" class="glow-input"></select>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;"><button type="submit" class="glow-btn">Save Changes</button><button type="button" class="glow-btn secondary modal-cancel-btn">Cancel</button></div>
        </form>
    </div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBF8WGFStX62SCFqhMzqcvIFI0LZTJfd30",
            authDomain: "social-media-420.firebaseapp.com",
            databaseURL: "https://social-media-420-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "social-media-420",
            storageBucket: "social-media-420.firebasestorage.app",
            messagingSenderId: "137093270524",
            appId: "1:137093270524:web:2847379ede160b6c73c079"
        };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getDatabase(app);
        
        const DOM = {
            loginScreen: document.getElementById('login-screen'), adminDashboard: document.getElementById('admin-dashboard'),
            loginForm: document.getElementById('login-form'), loginError: document.getElementById('login-error'),
            logoutBtn: document.getElementById('logout-btn'), 
            views: document.querySelectorAll('.view'), navBtns: document.querySelectorAll('.nav-btn'),
            productGrid: document.getElementById('product-grid'), membershipGrid: document.getElementById('membership-grid'),
            bannerGrid: document.getElementById('banner-grid'), userList: document.getElementById('user-list'), ordersList: document.getElementById('orders-list'),
            productModal: document.getElementById('product-modal'), productForm: document.getElementById('product-form'),
            bannerModal: document.getElementById('banner-modal'), bannerForm: document.getElementById('banner-form'),
            membershipModal: document.getElementById('membership-modal'), membershipForm: document.getElementById('membership-form'),
            userDetailModal: document.getElementById('user-detail-modal'), userEditModal: document.getElementById('user-edit-modal'),
            modalTitle: document.getElementById('modal-title'), fab: document.getElementById('fab-add-btn')
        };
        
        let currentView = 'products-view', allMemberships = {};

        const switchView = (viewId) => {
            currentView = viewId;
            DOM.views.forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            DOM.navBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${viewId}"]`).classList.add('active');
            if (['products-view', 'banners-view', 'memberships-view'].includes(viewId)) DOM.fab.classList.remove('hidden');
            else DOM.fab.classList.add('hidden');
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                DOM.loginScreen.classList.add('hidden'); DOM.adminDashboard.classList.remove('hidden');
                loadDashboardData(); switchView('products-view');
            } else {
                DOM.loginScreen.classList.remove('hidden'); DOM.adminDashboard.classList.add('hidden');
            }
        });

        DOM.loginForm.addEventListener('submit', e => { e.preventDefault(); signInWithEmailAndPassword(auth, email.value, password.value).catch(err => DOM.loginError.textContent = err.message); });
        DOM.logoutBtn.addEventListener('click', () => signOut(auth));
        DOM.navBtns.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));

        function loadDashboardData() {
            onValue(ref(db, 'products'), s => { renderGrid(DOM.productGrid, s.val(), createProductCard, 'No products.'); });
            onValue(ref(db, 'memberships'), s => { allMemberships = s.val() || {}; renderGrid(DOM.membershipGrid, allMemberships, createMembershipCard, 'No membership plans.'); });
            onValue(ref(db, 'banners'), s => { renderGrid(DOM.bannerGrid, s.val(), createBannerCard, 'No banners.'); });
            onValue(ref(db, 'users'), s => { renderList(DOM.userList, s.val(), createUserCard, 'No users.'); });
            onValue(ref(db, 'orders'), s => { renderList(DOM.ordersList, s.val(), createOrderCard, 'No orders.'); });
            onValue(ref(db, 'policies'), s => { loadPolicies(s.val()); });
        }

        const renderGrid = (el, data, cardFn, msg) => { el.innerHTML = data ? '' : `<p>${msg}</p>`; if (data) Object.entries(data).forEach(([k, i]) => el.appendChild(cardFn(k, i))); };
        const renderList = (el, data, cardFn, msg) => { el.innerHTML = data ? '' : `<p>${msg}</p>`; if (data) Object.entries(data).reverse().forEach(([k, i]) => el.appendChild(cardFn(k, i))); };
        
        const createProductCard = (id, p) => {
            const card = document.createElement('div'); card.className = 'item-card';
            card.innerHTML = `<img src="${p.imageUrl}" alt="${p.title}"><h3>${p.title}</h3><p>${(p.description || "").substring(0, 80)}...</p><div class="price">₹${p.discountPrice}</div><div class="item-card-actions"><button class="icon-btn edit-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button><button class="icon-btn delete-btn" title="Delete"><i class="fa-solid fa-trash"></i></button></div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => openProductModal(id, p));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteItem('products', id, 'product'));
            return card;
        };
        const openProductModal = (id = null, data = {}) => {
            DOM.productForm.reset(); DOM.productModal.classList.add('active');
            document.getElementById('modal-title').textContent = id ? 'Edit Product' : 'Add Product';
            if (id) {
                Object.keys(data).forEach(key => { const el = document.getElementById(`product${key.charAt(0).toUpperCase() + key.slice(1)}`); if(el) el.value = data[key]; });
                document.getElementById('productId').value = id;
            } else { document.getElementById('productId').value = ''; }
        };
        DOM.productForm.addEventListener('submit', e => {
            e.preventDefault(); const id = productId.value;
            const data = { title: productTitle.value, imageUrl: productImageUrl.value, description: productDescription.value, originalPrice: originalPrice.value, discountPrice: discountPrice.value, paymentLink: paymentLink.value, createdAt: new Date().toISOString() };
            const dbRef = id ? ref(db, `products/${id}`) : push(ref(db, 'products'));
            set(dbRef, data).then(() => { alert('Product saved!'); DOM.productModal.classList.remove('active'); }).catch(err => alert(`Error: ${err.message}`));
        });

        const createMembershipCard = (id, m) => {
            const card = document.createElement('div'); card.className = 'item-card';
            card.innerHTML = `<h3>${m.planName} <span style="color:var(--accent-glow);font-size:0.8rem;">${m.tagline || ''}</span></h3><p>${m.description}</p><div class="price">$${m.price} ${m.billingCycle}</div><div class="item-card-actions"><button class="icon-btn edit-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button><button class="icon-btn delete-btn" title="Delete"><i class="fa-solid fa-trash"></i></button></div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => openMembershipModal(id, m));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteItem('memberships', id, 'membership plan'));
            return card;
        };
        const openMembershipModal = (id = null, data = {}) => {
            DOM.membershipForm.reset(); DOM.membershipModal.classList.add('active');
            document.getElementById('membership-modal-title').textContent = id ? 'Edit Membership' : 'Add Membership';
            if (id) {
                document.getElementById('membershipId').value = id;
                document.getElementById('planName').value = data.planName || ''; document.getElementById('tagline').value = data.tagline || '';
                document.getElementById('price').value = data.price || ''; document.getElementById('billingCycle').value = data.billingCycle || '';
                document.getElementById('yearlyPrice').value = data.yearlyPrice || ''; document.getElementById('description').value = data.description || '';
                document.getElementById('features').value = data.features || ''; document.getElementById('membershipPaymentLink').value = data.paymentLink || '';
            } else { document.getElementById('membershipId').value = ''; }
        };
        DOM.membershipForm.addEventListener('submit', e => {
            e.preventDefault(); const id = membershipId.value;
            const data = { planName: planName.value, tagline: tagline.value, price: price.value, billingCycle: billingCycle.value, yearlyPrice: yearlyPrice.value, description: description.value, features: features.value, paymentLink: membershipPaymentLink.value };
            const dbRef = id ? ref(db, `memberships/${id}`) : push(ref(db, 'memberships'));
            set(dbRef, data).then(() => { alert('Membership plan saved!'); DOM.membershipModal.classList.remove('active'); }).catch(err => alert(`Error: ${err.message}`));
        });

        const createBannerCard = (id, banner) => {
            const card = document.createElement('div'); card.className = 'item-card';
            card.innerHTML = `<img src="${banner.imageUrl}" alt="Banner"><p>Links to: ${banner.linkUrl || 'N/A'}</p><div class="item-card-actions"><button class="icon-btn edit-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button><button class="icon-btn delete-btn" title="Delete"><i class="fa-solid fa-trash"></i></button></div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => openBannerModal(id, banner));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteItem('banners', id, 'banner'));
            return card;
        };
        const openBannerModal = (id = null, data = {}) => {
            DOM.bannerForm.reset(); DOM.bannerModal.classList.add('active');
            document.getElementById('banner-modal-title').textContent = id ? 'Edit Banner' : 'Add Banner';
            if(id) {
                document.getElementById('bannerId').value = id;
                document.getElementById('bannerImageUrl').value = data.imageUrl || '';
                document.getElementById('bannerLinkUrl').value = data.linkUrl || '';
            } else { document.getElementById('bannerId').value = ''; }
        };
        DOM.bannerForm.addEventListener('submit', e => {
            e.preventDefault(); const id = document.getElementById('bannerId').value;
            const data = { imageUrl: bannerImageUrl.value, linkUrl: bannerLinkUrl.value };
            const dbRef = id ? ref(db, `banners/${id}`) : push(ref(db, 'banners'));
            set(dbRef, data).then(() => { alert('Banner saved!'); DOM.bannerModal.classList.remove('active'); }).catch(err => alert(`Error: ${err.message}`));
        });

        const createUserCard = (uid, user) => {
            const p = user.profile || {}; const card = document.createElement('div'); card.className = 'list-item-card';
            card.innerHTML = `<div class="list-item-header">
                                <div class="list-item-main" data-uid="${uid}">
                                    <h3>${p.name || 'Unnamed User'} ${p.activeMembershipName ? `<span class="membership-badge">${p.activeMembershipName}</span>` : ''}</h3>
                                    <p><strong>Email:</strong> ${p.email || 'N/A'}</p>
                                </div>
                                <div class="item-card-actions">
                                    <button class="icon-btn edit-btn"><i class="fa-solid fa-user-pen"></i></button>
                                    <button class="icon-btn delete-btn"><i class="fa-solid fa-trash"></i></button>
                                </div>
                              </div>`;
            card.querySelector('.list-item-main').addEventListener('click', () => openUserDetailModal(uid, user));
            card.querySelector('.edit-btn').addEventListener('click', () => openUserEditModal(uid, p));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteItem('users', uid, 'user data'));
            return card;
        };
        const createOrderCard = (id, order) => {
            const card = document.createElement('div'); card.className = 'list-item-card';
            card.innerHTML = `<div class="list-item-header"><h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Order #${id.substring(id.length - 6).toUpperCase()}</h3><button class="icon-btn delete-btn" title="Delete Order"><i class="fa-solid fa-trash"></i></button></div><p><strong>Product:</strong> ${order.productSnapshot.title}</p><p><strong>Customer:</strong> ${order.userInput.name} (${order.userInput.email})</p><p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>`;
            card.querySelector('.delete-btn').addEventListener('click', () => deleteItem('orders', id, 'order'));
            return card;
        };
        
        async function openUserDetailModal(uid, user) {
            const p = user.profile || {};
            document.getElementById('user-detail-title').textContent = p.name || 'User Details';
            document.getElementById('user-detail-content').innerHTML = `<p><strong>Email:</strong> ${p.email || 'N/A'}</p><p><strong>Phone:</strong> ${p.phone || 'N/A'}</p><p><strong>Address:</strong> ${p.address || 'N/A'}</p><p><strong>Active Plan:</strong> ${p.activeMembershipName || 'None'}</p>`;
            const purchasesList = document.getElementById('user-purchases-list');
            const bookmarksList = document.getElementById('user-bookmarks-list');
            purchasesList.innerHTML = '<li>Loading...</li>'; bookmarksList.innerHTML = '<li>Loading...</li>';
            DOM.userDetailModal.classList.add('active');
            if(user.purchases) {
                purchasesList.innerHTML = '';
                for (const orderId of Object.keys(user.purchases)) {
                    const orderSnap = await get(ref(db, `orders/${orderId}`));
                    if (orderSnap.exists()) {
                        const order = orderSnap.val(); const li = document.createElement('div'); li.className = 'list-item-card';
                        li.innerHTML = `<p><strong>${order.productSnapshot.title}</strong> (₹${order.productSnapshot.price})</p><p><small>${new Date(order.createdAt).toLocaleString()}</small></p>`;
                        purchasesList.appendChild(li);
                    }
                }
            } else { purchasesList.innerHTML = '<p>No purchase history.</p>'; }
            if(user.bookmarks) {
                bookmarksList.innerHTML = '';
                for (const productId of Object.keys(user.bookmarks)) {
                    const productSnap = await get(ref(db, `products/${productId}`));
                    if (productSnap.exists()) {
                        const product = productSnap.val(); const li = document.createElement('div'); li.className = 'list-item-card';
                        li.innerHTML = `<p><strong>${product.title}</strong> (₹${product.discountPrice})</p>`;
                        bookmarksList.appendChild(li);
                    }
                }
            } else { bookmarksList.innerHTML = '<p>No bookmarked items.</p>'; }
        }
        
        const openUserEditModal = (uid, profileData) => {
            DOM.userEditModal.classList.add('active');
            const form = document.getElementById('user-edit-form');
            form.reset();
            form.userId.value = uid;
            form.userEmail.value = profileData.email || '';
            form.userName.value = profileData.name || '';
            form.userPhone.value = profileData.phone || '';
            form.userAddress.value = profileData.address || '';
            form.userImageUrl.value = profileData.imageUrl || '';
            
            const membershipSelect = document.getElementById('userMembership');
            membershipSelect.innerHTML = '<option value="">None</option>';
            for (const [id, plan] of Object.entries(allMemberships)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = plan.planName;
                membershipSelect.appendChild(option);
            }
            membershipSelect.value = profileData.activeMembershipId || '';
        };

        document.getElementById('user-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const uid = form.userId.value;
            if (!uid) return;
            
            const snap = await get(ref(db, `users/${uid}/profile`));
            const existingProfile = snap.val() || {};
            
            const selectedMembershipId = form.userMembership.value;
            const selectedMembershipName = selectedMembershipId ? allMemberships[selectedMembershipId].planName : "";

            const data = {
                ...existingProfile,
                name: form.userName.value,
                phone: form.userPhone.value,
                address: form.userAddress.value,
                imageUrl: form.userImageUrl.value,
                activeMembershipId: selectedMembershipId,
                activeMembershipName: selectedMembershipName
            };
            set(ref(db, `users/${uid}/profile`), data)
                .then(() => { alert('User profile updated!'); DOM.userEditModal.classList.remove('active'); })
                .catch(err => alert(`Error: ${err.message}`));
        });

        function loadPolicies(policies) {
            if (!policies) return;
            for (const [key, value] of Object.entries(policies)) {
                const textarea = document.getElementById(`policy-${key}`);
                if (textarea) textarea.value = value.content;
            }
        }
        document.querySelectorAll('.policy-form').forEach(form => {
            form.addEventListener('submit', e => {
                e.preventDefault(); const key = e.target.dataset.key;
                const content = document.getElementById(`policy-${key}`).value;
                const title = document.querySelector(`label[for="policy-${key}"]`).textContent;
                set(ref(db, `policies/${key}`), { title, content })
                    .then(() => alert(`${title} saved successfully!`)).catch(err => alert(`Error: ${err.message}`));
            });
        });

        DOM.fab.addEventListener('click', () => {
            if (currentView === 'products-view') openProductModal();
            else if (currentView === 'banners-view') openBannerModal();
            else if (currentView === 'memberships-view') openMembershipModal();
        });
        document.querySelectorAll('.modal-cancel-btn').forEach(btn => btn.addEventListener('click', () => {
            DOM.productModal.classList.remove('active'); DOM.bannerModal.classList.remove('active');
            DOM.userDetailModal.classList.remove('active'); DOM.membershipModal.classList.remove('active');
            DOM.userEditModal.classList.remove('active');
        }));
        function deleteItem(path, id, name) {
            if (confirm(`Are you sure you want to delete this ${name}? This action cannot be undone.`)) {
                remove(ref(db, `${path}/${id}`)).then(() => alert(`${name} deleted.`)).catch(err => alert(`Error: ${err.message}`));
            }
        }
    </script>
</body>
</html>
